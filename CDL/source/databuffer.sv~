// $Id: $
// File name:   databuffer.sv
// Created:     4/15/2019
// Author:      Ray Yan
// Lab Section: 2
// Version:     1.0  Initial Design Entry
// Description: 4.1.1
module databuffer
(
	input clk,
	input n_rst,

	input wire store_rx_packet,
	input wire store_tx_data,
	input wire get_rx_data,
	input wire get_tx_packet,

	input [7:0] rx_packet_data,
	input wire [7:0] tx_data,
	

	input wire flush,
	input wire clear,
	output reg [7:0] tx_packet_data,
	output reg [7:0] rx_data,
	output reg [7:0] buffer_occupancy
);

reg [7:0] buff_count;
reg [7:0] next_buff;
reg [31:0] rxreg;
reg [31:0] txreg;
reg [31:0] nrxreg;
reg [31:0] ntxreg;

always_ff @ (posedge clk, negedge n_rst) begin
	if (!n_rst) begin
		rxreg = 0;
		txreg = 0;
		buff_count = 0;
	end
	else begin
		rxreg = nrxreg;
		txreg = ntxreg;
		buff_count = next_buff;
	end
end

always_comb begin
	tx_packet_data = 0;
	rx_data = 0;
	nrxreg = rxreg;
	ntxreg = txreg;
	next_buff = buff_count;
	if (store_rx_packet) begin
		if (rxreg[31:24] == 8'b0) begin
			nrxreg[31:24] = rx_packet_data;
		end
		else if (rxreg[23:16] == 8'b0) begin
			nrxreg[23:16] = rx_packet_data;
		end
		else if (rxreg[15:8] == 8'b0) begin
			nrxreg[15:8] = rx_packet_data;
		end
		else if (rxreg[7:0] == 8'b0) begin
			nrxreg[7:0] = rx_packet_data;
		end
		next_buff = buff_count + 1;
	end
	if (store_tx_data) begin
		if (txreg[31:24] == 8'b0) begin
			ntxreg[31:24] = tx_data;
		end
		else if (txreg[23:16] == 8'b0) begin
			ntxreg[23:16] = tx_data;
		end
		else if (txreg[15:8] == 8'b0) begin
			ntxreg[15:8] = tx_data;
		end
		else if (txreg[7:0] == 8'b0) begin
			ntxreg[7:0] = tx_data;
		end
		next_buff = buff_count + 1;
	end
	if (get_rx_data) begin
		rx_data = rxreg[31:24];
		nrxreg[31:24] = rxreg[23:16];
		nrxreg[23:16] = rxreg[15:8];
		nrxreg[15:8] = rxreg[7:0];
		nrxreg[7:0] = 8'b0;
		next_buff = buff_count - 1;
	end
	if (get_tx_packet) begin
		tx_packet_data = txreg[31:24];
		ntxreg[31:24] = txreg[23:16];
		ntxreg[23:16] = txreg[15:8];
		ntxreg[15:8] = txreg[7:0];
		ntxreg[7:0] = 8'b0;
		next_buff = buff_count - 1;
	end
end

endmodule
